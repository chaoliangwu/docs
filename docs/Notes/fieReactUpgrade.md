## å‡çº§åŠ¨æœº

å·¥ä½œä¸­ä¸¤æ¬¾æ’ä»¶éƒ½æ˜¯ä½¿ç”¨ [fie-toolkit-qnui](https://github.com/fieteam/fie-toolkit-qnui)å¥—ä»¶è¿›è¡Œå¼€å‘ã€‚ä½¿ç”¨ä¸­å‘ç°äº†å®ƒçš„å¼Šç«¯ï¼š

- å†…ç½®çš„ React ç‰ˆæœ¬æ˜¯ `15.6`ï¼Œè€Œç°åœ¨ React å·²ç»è¿­ä»£å¸¦åˆ° `16.9`ã€‚æ–°ç‰ˆçš„ React è‚¯å®šæ¯”æ—§ç‰ˆçš„æ›´å¿«ï¼Œæ›´ç¨³å®šã€‚å¹¶ä¸”å¾ˆå¤šä¼˜ç§€çš„APIï¼ˆæ¯”å¦‚ç¬”è€…æœ€å–œæ¬¢çš„[Hooks](https://zh-hans.reactjs.org/docs/hooks-intro.html)ï¼‰è€ç‰ˆæœ¬è‡ªç„¶æ˜¯æ— æ³•ä½¿ç”¨ã€‚
- fie åœ¨å¼€å‘ç¯å¢ƒä¸‹ä»ç„¶ä½¿ç”¨ `production.min.js` ã€‚è¿™å°†ä¼šå¿½ç•¥ **è¯­æ³•æ£€æŸ¥** å’Œ **æ€§èƒ½æç¤º**ï¼Œä¸åˆ©äºæˆ‘ä»¬æ„å»ºæ›´å¥½æ›´å¿«çš„åº”ç”¨ã€‚
- ç”Ÿäº§æ¨¡å¼ä¸‹çš„`ReactDom`æ¸²æŸ“å¼‚å¸¸æŠ¥é”™ï¼Œæ²¡æœ‰ä»»ä½•çš„é”™è¯¯ä»¥åŠå †æ ˆä¿¡æ¯ï¼Œæœ‰çš„åªæ˜¯ç½‘é¡µé“¾æ¥ï¼Œæ‰“å¼€åæ‰ä¼šæ˜¾ç¤ºæˆ‘ä»¬çš„é”™è¯¯ä¿¡æ¯ã€‚ä½†è¿™å¯¹debugæ²¡æœ‰ä¸æ¯«å¸®åŠ©ã€‚ä»£ç è¿™ä¹ˆå¤šï¼Œå®Œå…¨ä¸çŸ¥é“æ˜¯å“ªé‡Œçš„é—®é¢˜ã€‚


è¿™å°±è®©ä¸‹å®šäº†å‡çº§Reactçš„å†³å¿ƒã€‚

è¿™ä¹ˆç®€å•çš„é—®é¢˜è‚¯å®šä¸æ­¢ç¬”è€…ä¸€ä¸ªäººæƒ³åˆ°ï¼Œäºæ˜¯ä¹å…´å†²å†²çš„è·‘å» github çœ‹çœ‹æœ‰æ²¡æœ‰äººæ issueï¼Œ
ä½†ç»“æœè®©æˆ‘å¾ˆæ˜¯éœ‡æƒŠã€‚

fie çš„æœ€åæ›´æ–°æ—¶é—´æ˜¯ä¸¤å¹´ä¹‹å‰ï¼Œè€Œè„šæ‰‹æ¶é…å¥—çš„[QNUI](https://github.com/INTL-Alibaba/qnui)ç»„ä»¶åº“,ä¹ŸåŒæ ·æ˜¯ä¸¤å¹´æ²¡æœ‰æ›´æ–°äº†ã€‚

çœ‹ä»–ä»¬çš„ github å‘ç°é¡¹ç›®ç»„å¾—äººéƒ½è·‘å»éš”å£åš [FusionDesign](https://fusion.design)äº†ã€‚ã€‚ã€‚ğŸ¤£

æƒ³è¦æ¢æ¶æ„è‚¯å®šæ˜¯ä¸å¯èƒ½äº†ï¼ŒåŠ¨è¾„ä¸Šä¸‡è¡Œä»£ç ï¼Œæˆæœ¬å®åœ¨æ˜¯éš¾ä»¥é¢„ä¼°ã€‚ã€‚

åªæœ‰è‡ªå·±ç¢ç£¨ç¢ç£¨å‡çº§æ–¹æ³•äº†ã€‚

## å‡çº§è¿‡ç¨‹

è„šæ‰‹æ¶å‡çº§è¡¨ç°å€’è¿˜ä»¤äººæ»¡æ„ï¼Œä¿®æ”¹`package.json`ï¼Œæ‰§è¡Œ `npm install`ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸€æ°”å‘µæˆï¼Œä¹Ÿæ²¡é‡åˆ°å•¥æŠ¥é”™ã€‚

å¯åŠ¨æœåŠ¡åæ‰“å¼€é¡µé¢ï¼Œwaitï¼ï¼ï¼ä¸æ˜¯å‡çº§äº†å—ï¼Œæ€ä¹ˆè¿˜æ˜¯ 15.6 ,ä¹Ÿæ²¡æœ‰ä»»ä½•æç¤ºï¼Ÿï¼ï¼

### 1# å‘
è§‚å¯Ÿ`webpack.confog.js`æˆ‘ä»¬å¯ä»¥å‘ç°
```jsx harmony
 externals: {
     'react': 'React',
      'react-dom': 'ReactDOM',
      'react-redux': 'ReactRedux',
      'react-router': 'ReactRouter',
      'react-router-redux': 'ReactRouterRedux',
      'redux-thunk': 'var window.ReduxThunk.default',
      'redux': 'Redux',
      'qnui': 'qnui' ,
      'react/lib/ReactTransitionGroup': 'var window.React.addons.TransitionGroup',
      'react/lib/ReactCSSTransitionGroup': 'var window.React.addons.CSSTransitionGroup',
    }
```
fie æ‰“åŒ…æ—¶ç›´æ¥æŠŠ React æ’é™¤æ‰äº†ï¼Œé‡‡ç”¨çš„æ˜¯å¼•å…¥ script çš„å½¢å¼ã€‚è¿™é‡Œæˆ‘ä»¬è¦æŠŠæœ€æ–°çš„æºç æ‹·è´å‡ºæ¥ï¼Œå¹¶å¯¹ fie çš„é…ç½®è¿›è¡Œä¿®æ”¹ã€‚

### 1# è§£å†³
1. åœ¨é¡¹ç›®ä¸­æ–°å»ºç›®å½•ï¼Œ`/lib/production/` å’Œ `/lib/development/`
2. è¿›å…¥ react å’Œ react-dom çš„ cjs ç›®å½•ä¸‹ï¼Œåˆ†åˆ«å°† `react.production.min.js` `react-dom.pruduction.min.js`ï¼Œ
`react.development.js` `react-dom.development.js` æ‹·è´åˆ°åˆšæ‰åˆ›å»ºçš„ç›®å½•ä¸‹ã€‚å¹¶å°†ä»–ä»¬é‡å‘½åä¸º`react.js`å’Œ`react-dom.js`
3. ä¿®æ”¹`fie.config.js`
```jsx{14,20}
module.exports = {
  toolkit: 'fie-toolkit-qnui',

  toolkitConfig: {
    port: 9001,
    open: false,
    openTarget: 'pages/root.html',
    liveload: true
  },

  tasks: {
    start: [
      {
        command: 'NODE_ENV=development node build.js' 
        // å¿½ç•¥æç¤ºä¿¡æ¯ï¼Œå¯ä»¥åœ¨æ­¤æŒ‡å®š NODE_ENV=production
      }
    ],
    build: [
      {
        command: 'NODE_ENV=production node build.js'
      }
    ],
    deploy: [
      {
        command: 'node deploy.js'
      }
    ],
    publish: []
  }
};
```
::: warning æç¤º
è¿™é‡ŒåŒºåˆ† **å¼€å‘ç¯å¢ƒ** å’Œ **ç”Ÿäº§ç¯å¢ƒ**ï¼Œç›®çš„æ˜¯åœ¨å¼€å‘ç¯å¢ƒæ„å»ºä¸­æ˜¾ç¤ºå®Œæ•´çš„ **è¯­æ³•æ£€æŸ¥** å’Œ **æ€§èƒ½æç¤º**ã€‚

è‹¥ä¸éœ€è¦ï¼Œå¯å°† start å’Œ build å…¨éƒ¨æŒ‡å®š NODE_ENV=production
:::



4. ä¿®æ”¹ `build.js`
```jsx{12}
let fs = require('fs-extra');
let globby = require('globby');
let path = require('path');

globby([
  'node_modules/babel-polyfill/dist/*',
  'node_modules/react-redux/dist/*',
  'node_modules/react-router/umd/*',
  'node_modules/react-router-redux/dist/*',
  'node_modules/redux-thunk/dist/*',
  'node_modules/redux/dist/*',
  `lib/${process.env.NODE_ENV}/*`, 
]).then(paths => {
  fs.mkdirsSync('build/lib/');
  paths.forEach((item) => {
    let filename = path.basename(item);
    fs.copySync(item, 'build/lib/' + filename);
  });
});
//ä½¿ç”¨ç»Ÿè®¡

console.log('copy files to build/lib done ! mode:'+ process.env.NODE_ENV);
```
5. ä¿®æ”¹`pages/js/root.js`

è¿™ä¸ªæ–‡ä»¶æ˜¯ fie å¯¹å„ç§å¤–ç½® script è¿›è¡ŒåŠ è½½çš„è¿‡ç¨‹ï¼Œä¸Šä¸€æ­¥æˆ‘ä»¬ä¿®æ”¹äº†è¦å¼•å…¥çš„ script æ–‡ä»¶åï¼Œè¦åœ¨è¿™é‡Œè¿›è¡Œé€‚é…ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åŠ è½½é¡ºåºä¸º :

`polyfill` => `react-with-addons` => `react-dom` => `redux` => `... ...`

è¿™é‡Œçš„ react-with-addons å°±æ˜¯ React 15.6 å’Œ React-addons çš„åˆä½“ã€‚

æˆ‘ä»¬å°†å…¶è·¯å¾„ä¿®æ”¹ä¸º`../build/lib/react.js`,å°† react-dom è·¯å¾„ä¿®æ”¹ä¸º`../build/lib/react-dom.js`

åˆ°è¿™é‡Œï¼Œç¬¬ä¸€æ­¥è„šæ‰‹æ¶çš„ä¿®æ”¹å·¥ä½œå°±å®Œæˆäº†ï¼ï¼ˆä½†å¥½åƒäº‹æƒ…æ²¡æœ‰è¿™ä¹ˆç®€å•ğŸ˜‚ï¼‰

okï¼Œæ‰§è¡Œ `fie start`ï¼Œæ‰“å¼€æˆ‘ä»¬ç†Ÿæ‚‰çš„ç•Œé¢ï¼Œå‘ç°ä¸€ç‰‡ç©ºç™½ã€‚äºæ˜¯ä¹ F12 æ‰“å¼€æ§åˆ¶å°ï¼Œæœä¸å…¶ç„¶ä¸€ç‰‡æŠ¥é”™ã€‚
å…¶ä¸­æœ€æ˜¾çœ¼çš„ä¸¤ä¸ª:
- `Cannot read property 'string' of undefined`
- `Cannot read property 'createClass' of undefined`
- `Cannot read property 'ReactTransitionGroup' of undefined`

æ‰“å¼€å †æ ˆä¿¡æ¯ä¸€çœ‹ï¼Œå…¨éƒ½æ˜¯å¹´è¿ˆçš„ QNUI æŠ¥çš„é”™ã€‚
### 2# å‘
React16 å»é™¤æ‰äº†`PropTypes` `createClass` ä»¥åŠ `ReactTransitionGroup`ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯`prop-types` `create-react-class` å’Œ `react-transition-group`ç¬¬ä¸‰æ–¹åº“ã€‚

è€Œå¹´ä¹…å¤±ä¿®çš„QNUIï¼Œåœ¨ä½¿ç”¨`react.PropTypes.string`ä»¥åŠ`react.createClass`æ—¶ï¼Œå°±ä¼šå‡ºé”™äº†ã€‚

### 2# è§£å†³

æœ¬æ¥ç¬”è€…çš„æƒ³æ³•æ˜¯å¯¹ React åº“è¿›è¡Œä¿®æ”¹ï¼ŒæŠŠåˆ æ‰çš„ä¸‰ä¸ªAPIæ·»åŠ è¿›å»ã€‚æƒ³äº†æƒ³å®åœ¨æ˜¯å¤ªéº»çƒ¦ï¼Œå¯¹æºç åŠ¨åˆ€å¯æ˜¯ä¸€ä¸å°å¿ƒå°±è¦GGçš„ã€‚

æœ€åä½¿ç”¨äº†ä¸€ä¸ªå·§å¦™åœ°æ–¹å¼ï¼Œä¹‹å‰åœ¨ä¿®æ”¹`pages/js/root.js`æ—¶ï¼Œå¼•å…¥äº† `react-with-addons`ã€‚å…¶ä¸­å°±åŒ…å«äº†react 15ã€‚è€Œæˆ‘ä»¬éœ€è¦çš„ä¸‰ä¸ªAPIï¼Œè¿™ä¸æ˜¯å¾—æ¥å…¨ä¸è´¹åŠŸå¤«å˜›ã€‚

æ¥ç€ä¿®æ”¹`root.js`ï¼Œåˆ†ä¸‰æ­¥èµ°ï¼š
- å…ˆå¼•ç”¨`react-with-addons`ï¼Œå°†ä¸‰ä¸ªAPIæŠ½å‡ºæ¥ã€‚
- ç„¶åå¼•ç”¨`react16`ï¼Œè¦†ç›–æ‰`react15`ã€‚
- å°†æŠ½å‡ºæ¥çš„ä¸‰ä¸ªAPIæ·»åŠ åˆ° react16 ä¸­ã€‚ï¼ˆä¸çŸ¥é“ä¼šå¼•å‘ä»€ä¹ˆæœªçŸ¥çš„é—®é¢˜ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚è¿™æ˜¯åè¯ï¼‰
```js{2,7,8,10,15,16,17}
polyfill.onload = function () {
  reactWith.setAttribute('src', '../build/lib/react-with-addons.min.js?qntag=1');
  reactWith.setAttribute('type', 'text/javascript');
  reactWith.setAttribute('crossorigin', '');
  document.getElementsByTagName('head')[0].appendChild(reactWith);
  reactWith.onload = function () {
    const {PropTypes, createClass,addons} = window.React
    window.React = null;
     var react = document.createElement('script');
     react.setAttribute('src', '../build/lib/react.js?qntag=1');
     react.setAttribute('type', 'text/javascript');
     react.setAttribute('crossorigin', '');
     document.getElementsByTagName('head')[0].appendChild(react);
     react.onload = function () {
        window.React.PropTypes = PropTypes;
        window.React.createClass = createClass;
        window.React.addons = addons;
        // ... ...
     }
  }
}
```

okï¼Œå¤©è¡£æ— ç¼ï¼

è¿è¡Œè¿˜æ˜¯ç™½å±ã€‚ç»§ç»­è§‚å¯Ÿæ§åˆ¶å°ï¼Œå‘ç°è¿™ä¹ˆä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼š

`Cannot read property 'addNodeForSafeClick' of null`


### 3# å‘
è¿˜æ˜¯QNUIæŠ¥é”™ã€‚æŸ¥çœ‹æºç æˆ‘ä»¬å‘ç°ï¼Œé”™è¯¯æ¥è‡ª Overlay æ¨¡æ€æ¡† ç»„ä»¶ã€‚
```jsx harmony
// ... ...
this.overlay = e['default'].unstable_renderSubtreeIntoContainer
      (this, overlay, this._wrap);
// ... ...

this.overlay.addNodeForSafeClick(node)
//... ...
```
å®ƒä½¿ç”¨äº†è¿™ä¹ˆä¸€ä¸ª API `ReactDom.unstable_renderSubtreeIntoContainer`

è¿™ä¸ª API çš„ä½œç”¨æ˜¯å°†å…ƒç´ æ¸²æŸ“åˆ°çˆ¶ç»„ä»¶ä¹‹å¤–çš„DOM,ç”¨æ¥åšå¼¹çª—æ•ˆæœå†é€‚åˆä¸è¿‡ã€‚ä½†ä»–æ¯•ç«Ÿæ˜¯æœ‰å‰ç¼€`unstable`çš„ï¼Œè‚¯å®šåœ¨æŸäº›æƒ…å†µä¸‹ä¼šæœ‰é—®é¢˜ã€‚

åœ¨ react15 ä¸­ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šç›´æ¥è¿”å›è¢«æ¸²æŸ“å…ƒç´ çš„å®ä¾‹ï¼Œè€Œ react16 åˆ™ä¼šè¿”å›`null`ã€‚

æ‰€ä»¥è¿™é‡Œä¼šæœ‰`Cannot read property 'addNodeForSafeClick' of null`è¿™ä¸ªé”™è¯¯å‡ºç°ã€‚

### 3# è§£å†³

React16æ–°å¢äº†[`Portals`](https://zh-hans.reactjs.org/docs/portals.html)æ¥æ›´å¥½çš„å®ç°è¯¥åŠŸèƒ½ã€‚

å¼€å§‹æ˜¯æƒ³ç›´æ¥æ›¿æ¢æ‰APIï¼Œä½†åæ¥å‘ç°ä¸¤ä¸ªAPIè™½ç„¶åŠŸèƒ½ç›¸åŒï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥å´å¤§ç›¸å¾„åº­ã€‚

å¦‚æœç”¨`Portals`æ”¹å†™æ•´ä¸ªç»„ä»¶ï¼Œé£é™©å’Œå·¥ä½œé‡è¿˜æ˜¯å¾ˆå¤§ã€‚å› ä¸ºæ•´ä¸ªQNUIå…³äºæµ®å±‚çš„ç»„ä»¶éƒ½æ˜¯åŸºäºè¿™ä¸ª`Overlay`ã€‚

æ²¡åŠæ³•åªèƒ½ç»§ç»­åˆ†ææºç ï¼Œçœ‹ä¸€ä¸‹ä¸ºå•¥ç°åœ¨è¿”å›æ˜¯ null ã€‚

åˆ†ææºç å‘ç°è¯¥APIå…è®¸æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°ç»‘å®šçš„`this`ä¸ºè¢«æ¸²æŸ“å…ƒç´ å®ä¾‹ã€‚è€Œè§¦å‘å›è°ƒæ—¶ä½¿ç”¨äº†ä¸€ä¸ª`flushSyncCallbackQueueImpl`çš„å†…éƒ¨APIï¼Œæ„æ€ä¹Ÿå°±æ˜¯å°†æ‰€æœ‰å›è°ƒæ”¾åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œç»Ÿä¸€æ‰§è¡Œã€‚

å¤§ä½“ä¸Šç†è§£å°±æ˜¯æ˜¯æ—§ç‰ˆåŒæ­¥æ¸²æŸ“å…ƒç´ ï¼Œæ¸²æŸ“å®Œæˆåå‡½æ•°è¿”å›ç»„ä»¶å®ä¾‹ï¼Œè€Œç°åœ¨æ”¹ä¸ºäº†å¼‚æ­¥æ¸²æŸ“ï¼Œéœ€è¦åœ¨å›è°ƒé‡Œè·å–å®ä¾‹ã€‚

è¿™æ ·ä¸€æ¥æ€è·¯å°±æ¸…æ™°äº†ï¼Œæˆ‘ä»¬åœ¨æ‰€æœ‰`unstable_renderSubtreeIntoContainer`çš„åœ°æ–¹åŠ å…¥å›è°ƒï¼Œåœ¨å›è°ƒä¸­å¤„ç†å®ä¾‹ç»‘å®šï¼Œè€Œåœ¨æ‰€æœ‰ä½¿ç”¨åˆ°è¯¥å®ä¾‹çš„åœ°æ–¹å°†å…¶åŠ å…¥å®ä»»åŠ¡é˜Ÿåˆ—å»¶è¿Ÿè°ƒç”¨ï¼Œé—®é¢˜è¿åˆƒè€Œè§£ã€‚

å¤§æ¦‚åƒè¿™æ ·ï¼š
```jsx harmony
// ... ...
var self4 = this;
 e['default'].unstable_renderSubtreeIntoContainer
      (this, overlay, this._wrap,function(){
        self4.overlay = this;
      });
// ... ...
setTimeout(()=>{
  this.overlay.addNodeForSafeClick(node)
})
//... ...
```

å¤„ç†å®Œè¿™ä¸€é—®é¢˜åï¼Œå°†æˆ‘ä»¬ hack åçš„åŒ…æ”¾åœ¨`lib/production/`ä¸‹ï¼Œç”¨å®ƒæ›¿æ¢qnui

`qnui.setAttribute('src', '//g.alicdn.com/qn/QNUI-OPEN/0.6.1/qnui.min.js?qntag=1');`

æ›¿æ¢ä¸º

 `qnui.setAttribute('src', '../build/lib/qnui.js?qntag=1');`
 


å†æ¬¡åˆ·æ–°é¡µé¢ï¼Œè¿™æ¬¡å› è¯¥ä¸ä¼šæœ‰å•¥é—®é¢˜äº†æŠŠã€‚ã€‚ã€‚

### 4# å‘

æˆ‘é ï¼Œè¿™æ¬¡å‡ºäº†ä¸€ä¸ªæ‘¸ä¸ç€å¤´è„‘çš„é—®é¢˜
```jsx harmony
Uncaught Error: Element ref was specified as a string (.$.$onsale) but no owner was set. This could happen for one of the following reasons:
1. You may be adding a ref to a function component
2. You may be adding a ref to a component that was not created inside a component's render method
3. You have multiple copies of React loaded
```
### 4# è§£å†³

è¿™ä¸ªé—®é¢˜çœ‹æè¿°å¤§æ¦‚æ˜¯ä½¿ç”¨äº†ä¸åŒçš„reactç‰ˆæœ¬å¯¼è‡´çš„ã€‚è§£å†³æ–¹æ³•ç¬”è€…ä¹Ÿæ˜¯è¯¯æ‰“è¯¯æ’ï¼Œå°†`react.addons.TransitionGroup`æ›¿æ¢ä¸ºäº†ç¬¬ä¸‰æ–¹åº“`react-transition-group`å°±å¥½äº†ã€‚

ä¿®æ”¹æ–¹å¼ï¼š
1. è¿˜æ˜¯`root.js`
åœ¨ script å¼•ç”¨ä¸­åŠ å…¥`react-transition-group`,åŒæ—¶ä¸åœ¨å°†`addons`æ·»åŠ åˆ°react16 ä¸Š
```jsx{2,11,16,17}
reactWith.onload = function () {
  const {PropTypes, createClass} = window.React
  window.React = null;
  var react = document.createElement('script');
  react.setAttribute('src', '../build/lib/react.js?qntag=1');
  react.setAttribute('type', 'text/javascript');
  react.setAttribute('crossorigin', '');
  document.getElementsByTagName('head')[0].appendChild(react);
  react.onload = function () {
    var addons = document.createElement('script');
    addons.setAttribute('src', '../build/lib/react-transition-group.min.js?qntag=1');
    addons.setAttribute('type', 'text/javascript');
    addons.setAttribute('crossorigin', '');
    document.getElementsByTagName('head')[0].appendChild(addons);
    addons.onload = function () {
      window.React.PropTypes = PropTypes;
      window.React.createClass = createClass;
      var reactDom = document.createElement('script');
      reactDom.setAttribute('src', '../build/lib/react-dom.js?qntag=1');
      reactDom.setAttribute('type', 'text/javascript');
      reactDom.setAttribute('crossorigin', '');
      document.getElementsByTagName('head')[0].appendChild(reactDom);
    }
  }
}
```
2. ä¿®æ”¹ `qn.js`
ç¬¬ä¸€è¡Œçš„ä½ç½®
```js
e.qnui = t(e.React, e.ReactDOM, e.React.addons.TransitionGroup)
```
ä¿®æ”¹ä¸º
```js
e.qnui = t(e.React, e.ReactDOM, e.ReactTransitionGroup.TransitionGroup)
```

è¿™é‡Œçš„ e ä¸ºå…¨å±€ window å¯¹è±¡ï¼Œæˆ‘ä»¬å¼•å…¥`react-transition-group`åï¼Œä¼šè‡ªåŠ¨ä¸º window æ³¨å…¥ `ReactTransitionGroup`


### 5# å‘
æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°è¿™æ ·ä¸€ä¸ªæŠ¥é”™
```js
Cannot read property 'getContentNode' of null
```

è¿˜æ˜¯ `Overlay` çš„é—®é¢˜ã€‚è¿™ä¸ªé”™è¯¯ä¸æ˜¯å¿…ç°çš„ã€‚å‡ºç°è¿™ä¸ªé”™è¯¯é¡»ç¬¦åˆä»¥ä¸‹æ¡ä»¶
- é¡µé¢å‡ºç°æµ®å±‚ä¹Ÿå°±æ˜¯Overlay
- Overlay çš„ç‚¹å‡»äº‹ä»¶ç›´æ¥è·³è½¬åˆ°æ–°é¡µé¢
- åœ¨æ–°é¡µé¢ä¸Šç‚¹å‡»å°±ä¼šæŠ¥é”™


### 5# è§£å†³

å…·ä½“çš„æºç å°±ä¸è´´äº†ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹å¤§ä½“åŸå› ï¼š

Overlayçš„ç‚¹å‡»äº‹ä»¶æ˜¯é€šè¿‡ `document.addEventlistener` ç»‘å®šçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š

å¼¹å±‚å‡ºç°åï¼Œqnui ä¸º document å¢åŠ  click ç›‘å¬ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æ—¶ï¼Œåˆ¤æ–­ç›®æ ‡å…ƒç´ æ˜¯å¦ä¸º Overlayã€‚å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæ‰§è¡Œç‚¹å‡»å›è°ƒï¼Œå¦‚æœä¸æ˜¯ï¼Œå°†å…¶éšè—ã€‚

å½“æˆ‘ä»¬è·¯ç”±è·³è½¬åˆ°æ–°é¡µé¢åï¼Œå¼¹å±‚ç›´æ¥è¢«å¸è½½,è€Œç›‘å¬æ²¡æœ‰å»é™¤ã€‚è¿™æ ·åœ¨æ–°é¡µé¢ç‚¹å‡»æ—¶è§¦å‘ç›‘å¬å¯¼è‡´æŠ¥é”™ã€‚

æºç åœ¨ componentWillUnmount ç”Ÿå‘½å‘¨æœŸä¸­æœ‰å»é™¤ç›‘å¬çš„æ“ä½œï¼Œä½†è¿™ä¸ªåœ°æ–¹ç›´æ¥è·³è½¬é¡µé¢ä¼šå¯¼è‡´ä»£ç æ‰§è¡Œè¢«æ‰“æ–­ã€‚

ä¸€å¼€å§‹æƒ³åˆ°è§£å†³æ–¹å¼æ˜¯ä¸ºè·³è½¬å¢åŠ å»¶è¿Ÿï¼Œä½†è€ƒè™‘åˆ°ç”¨æˆ·ä½“éªŒä»¥åŠç¨³å®šæ€§ï¼Œå†³å®šå¯¹ç»„ä»¶æºç åšä¸€ä¸‹å…¼å®¹ã€‚

- è°ƒç”¨ä¹‹å‰åˆ¤æ–­ç»„ä»¶æ˜¯å¦å·²å¸è½½ï¼Œå¦‚æœå·²å¸è½½ï¼Œåœæ­¢è°ƒç”¨å¹¶æ‰‹åŠ¨å»é™¤ç›‘å¬ã€‚



## å®Œæˆ
æ‰“å¼€æµè§ˆå™¨åˆ·æ–°é¡µé¢ï¼Œçœ‹ç€ä¹…è¿çš„é¡µé¢æµ®ç°åœ¨æˆ‘ä»¬çœ¼å‰ï¼ŒçœŸçš„æ˜¯ç•™ä¸‹äº†æ¿€åŠ¨åœ°å£æ°´ã€‚

`React 16`æˆ‘ä»¬å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºï¼

## é™„
### `root.js`
```js
// æ ¹æ®QueryStringå‚æ•°åç§°è·å–å€¼
function getQueryStringByName(name) {
  var result = location.search.match(new RegExp(`[\?\&]${name}=([^\&]+)`, 'i'));
  if (result == null || result.length < 1) {
    return '';
  }
  return result[1];
}

window.onload = function () {
  var version = "";
  //var version = "-2019072301"; //æ‰“åŒ…ä¹‹åçš„ç‰ˆæœ¬å·

  var event = decodeURI(getQueryStringByName('event'));

  var numiid = decodeURI(getQueryStringByName('iid')); // å•†å“è¯¦æƒ…
  var itemStatus = decodeURI(getQueryStringByName('itemStatus')); // å•†å“åˆ—è¡¨
  if (event) {
    if (event == 'event_itemList' || event == 'itemList') {
      if (itemStatus != null && itemStatus != '') {
        if (itemStatus == 'hasshowcase') { // æ©±çª—æ¨è--ä¹å®«æ ¼
          window.location.href = `${window.location.href.split('?')[0]}#/itemManage/itemList/${itemStatus}`;
        } else {
          window.location.href = `${window.location.href.split('?')[0]}#/itemManage/itemList`;
        }
      }
    } else if (event == 'event_itemDetail' || event == 'itemDetail') { // /å•†å“æ˜ç»† æ–°åŠ å‚æ•°itemDetail
      // window.location.href = "../pc/web/root.html?event=itemEdit&num_iid=" + numiid;
      window.location.href = `${window.location.href.split('?')[0]}#/itemManage/itemDetail/${numiid}`;
    } else if (event == 'customEvent') { // /è¿›å…¥å•†å“æ’ä»¶    æˆ–æŒ‡å®šåŠŸèƒ½
      var itemStatus = decodeURI(getQueryStringByName('itemStatus')); // ç±»å‹

      if (itemStatus != null && itemStatus != undefined && itemStatus != '') {
        if (itemStatus == 'itemList') { // å•†å“ç®¡ç†
          window.location.href = `${window.location.href.split('?')[0]}#/itemManage/itemList`;
        } else if (itemStatus == 'waterMark') { // ä¸»å›¾æ°´å°
          window.location.href = `${window.location.href.split('?')[0]}#/templet/waterMark`;
        } else if (itemStatus == 'mobileDetail') { // æ‰‹æœºè¯¦æƒ…
          window.location.href = `${window.location.href.split('?')[0]}#/mobileDetail`;
        } else if (itemStatus == 'smartList') { // æ™ºèƒ½ä¸Šä¸‹æ¶
          window.location.href = `${window.location.href.split('?')[0]}#/flowUp/smartList`;
        } else if (itemStatus == 'smartWindow') { // æ™ºèƒ½æ©±çª—
          window.location.href = `${window.location.href.split('?')[0]}#/flowUp/smartWindow`;
        } else if (itemStatus == 'titleOptimize') { // æ ‡é¢˜ä¼˜åŒ–
          window.location.href = `${window.location.href.split('?')[0]}#/flowUp/titleOptimize/itemList/aa`;
        } else if (itemStatus == 'activeCenter') { // æ´»åŠ¨ä¸­å¿ƒ
          window.location.href = `${window.location.href.split('?')[0]}#/more/activeCenter`;
        } else if (itemStatus == 'itemList') { // ä¼˜åŒ–å®è´
          window.location.href = `${window.location.href.split('?')[0]}#/itemManage/itemList`;
        } else if (itemStatus == 'editItem') { // ç¼–è¾‘å®è´
          var numIid = decodeURI(getQueryStringByName('numIid')); // å•†å“ç¼–å·
          window.location.href = `${window.location.href.split('?')[0]}#/itemManage/itemDetail/${numIid}`;
        }
      }
    } else {
      window.location.href = `${window.location.href.split('?')[0]}#/`;
    }
  } else {
    window.location.href = `${window.location.href.split('?')[0]}#/`;
  }

  var qncss = document.createElement('link');
  qncss.setAttribute('href', '//g.alicdn.com/qn/QNUI-OPEN/0.6.1/qnui.min.css?qntag=1');
  qncss.setAttribute('rel', 'stylesheet');
  qncss.setAttribute('type', 'text/css');
  document.getElementsByTagName('head')[0].appendChild(qncss);

  var css = document.createElement('link');
  css.setAttribute('href', `../build/pages/root/index${version}.css`); // æ³¨æ„ç‰ˆæœ¬å·
  css.setAttribute('rel', 'stylesheet');
  css.setAttribute('type', 'text/css');
  document.getElementsByTagName('head')[0].appendChild(css);

  var polyfill = document.createElement('script');
  polyfill.setAttribute('src', '../build/lib/polyfill.min.js?qntag=1');
  polyfill.setAttribute('type', 'text/javascript');
  polyfill.setAttribute('crossorigin', '');
  document.getElementsByTagName('head')[0].appendChild(polyfill);
  polyfill.onload = function () {
    var reactWith = document.createElement('script');
    reactWith.setAttribute('src', '../build/lib/react-with-addons.min.js?qntag=1');
    reactWith.setAttribute('type', 'text/javascript');
    reactWith.setAttribute('crossorigin', '');
    document.getElementsByTagName('head')[0].appendChild(reactWith);
    reactWith.onload = function () {
      const {PropTypes, createClass} = window.React
      window.React = null;
      var react = document.createElement('script');
      react.setAttribute('src', '../build/lib/react.js?qntag=1');
      react.setAttribute('type', 'text/javascript');
      react.setAttribute('crossorigin', '');
      document.getElementsByTagName('head')[0].appendChild(react);
      react.onload = function () {
        var addons = document.createElement('script');
        addons.setAttribute('src', '../build/lib/react-transition-group.min.js?qntag=1');
        addons.setAttribute('type', 'text/javascript');
        addons.setAttribute('crossorigin', '');
        document.getElementsByTagName('head')[0].appendChild(addons);
        addons.onload = function () {
          window.React.PropTypes = PropTypes;
          window.React.createClass = createClass;
          var reactDom = document.createElement('script');
          reactDom.setAttribute('src', '../build/lib/react-dom.js?qntag=1');
          reactDom.setAttribute('type', 'text/javascript');
          reactDom.setAttribute('crossorigin', '');
          document.getElementsByTagName('head')[0].appendChild(reactDom);
          reactDom.onload = function () {
            var redux = document.createElement('script');
            redux.setAttribute('src', '../build/lib/redux.min.js?qntag=1');
            redux.setAttribute('type', 'text/javascript');
            redux.setAttribute('crossorigin', '');
            document.getElementsByTagName('head')[0].appendChild(redux);
            redux.onload = function () {
              var reactRedux = document.createElement('script');
              reactRedux.setAttribute('src', '../build/lib/react-redux.min.js?qntag=1');
              reactRedux.setAttribute('type', 'text/javascript');
              reactRedux.setAttribute('crossorigin', '');
              document.getElementsByTagName('head')[0].appendChild(reactRedux);
              reactRedux.onload = function () {
                var reactRouter = document.createElement('script');
                reactRouter.setAttribute('src', '../build/lib/ReactRouter.min.js?qntag=1');
                reactRouter.setAttribute('type', 'text/javascript');
                reactRouter.setAttribute('crossorigin', '');
                document.getElementsByTagName('head')[0].appendChild(reactRouter);
                reactRouter.onload = function () {
                  var reactRouterRedux = document.createElement('script');
                  reactRouterRedux.setAttribute('src', '../build/lib/ReactRouterRedux.min.js?qntag=1');
                  reactRouterRedux.setAttribute('type', 'text/javascript');
                  reactRouterRedux.setAttribute('crossorigin', '');
                  document.getElementsByTagName('head')[0].appendChild(reactRouterRedux);
                  reactRouterRedux.onload = function () {
                    var thunk = document.createElement('script');
                    thunk.setAttribute('src', '../build/lib/redux-thunk.min.js?qntag=1');
                    thunk.setAttribute('type', 'text/javascript');
                    thunk.setAttribute('crossorigin', '');
                    document.getElementsByTagName('head')[0].appendChild(thunk);
                    thunk.onload = function () {
                      var qnui = document.createElement('script');
                      qnui.setAttribute('src', '../build/lib/qnui.js?qntag=1');
                      qnui.setAttribute('type', 'text/javascript');
                      qnui.setAttribute('crossorigin', '');
                      document.getElementsByTagName('head')[0].appendChild(qnui);
                      qnui.onload = function () {
                        var vendor = document.createElement('script');
                        vendor.setAttribute('src', `../build/vendor${version}.js`); // æ³¨æ„ç‰ˆæœ¬å·
                        vendor.setAttribute('type', 'text/javascript');
                        vendor.setAttribute('crossorigin', '');
                        document.getElementsByTagName('head')[0].appendChild(vendor);
                        vendor.onload = function () {
                          var itemManagement = document.createElement('script');
                          itemManagement.setAttribute('src', `../build/pages/root/index${version}.js`); // æ³¨æ„ç‰ˆæœ¬å·
                          itemManagement.setAttribute('type', 'text/javascript');
                          itemManagement.setAttribute('crossorigin', '');
                          document.getElementsByTagName('head')[0].appendChild(itemManagement);
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```
### build.js
```js
'use strict';

let fs = require('fs-extra');
let globby = require('globby');
let path = require('path');
//STEP 3 å°†lib copy åˆ° build ç›®å½•

globby([
  'node_modules/babel-polyfill/dist/*',
  'node_modules/react-redux/dist/*',
  'node_modules/react-router/umd/*',
  'node_modules/react-router-redux/dist/*',
  'node_modules/redux-thunk/dist/*',
  'node_modules/redux/dist/*',
  'lib/common/*',
  `lib/${process.env.NODE_ENV}/*`,
]).then(paths => {
  fs.mkdirsSync('build/lib/');
  paths.forEach((item) => {
    let filename = path.basename(item);
    fs.copySync(item, 'build/lib/' + filename);
  });
});
//ä½¿ç”¨ç»Ÿè®¡

console.log('copy files to build/lib done ! mode:'+process.env.NODE_ENV);

```

### fie.config.js
```js
/**
 * å¥—ä»¶å¸®åŠ©æ–‡æ¡£ å¯æŸ¥çœ‹: http://gitlab.alibaba-inc.com/fie/fie-toolkit-qnui
 */
module.exports = {
  // å½“å‰é¡¹ç›®ä½¿ç”¨çš„fieå¥—ä»¶
  toolkit: 'fie-toolkit-qnui',

  toolkitConfig: {
    // æœ¬åœ°æœåŠ¡å™¨ç«¯å£å·,ä¸ºä¸äº¤æ˜“å…±å­˜ï¼Œè®¾ç½®9001
    port: 9001,
    // æ˜¯å¦è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    open: false,
    // æ‰“å¼€æµè§ˆå™¨å è‡ªåŠ¨æ‰“å¼€çš„ ç›®æ ‡é¡µé¢
    openTarget: 'pages/root.html',
    // æ–‡ä»¶ä¿®æ”¹åæ˜¯å¦è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨
    liveload: true
  },

  tasks: {
    start: [
      {
        // æ‰§è¡Œbuildç›®å½•çš„copy
        command: 'NODE_ENV=development node build.js '
      }
    ],
    build: [
      {
        // åŒæ­¥ç±»åº“åˆ°build/libç›®å½•
       command: 'NODE_ENV=production node build.js'
      }
    ],
    deploy: [
      {
        //åŒæ­¥åˆ°tomcatæœåŠ¡å™¨
        command: 'node deploy.js'
      }
    ],
    publish: []
  }
};
```
### lib
```
lib
|- common
   |- react-transition-group.min.js
   |- react-with-addons.min.js
|- development
   |- qnui.js
   |- react.js
   |- react-dom.js
|- production
   |- qnui.js
   |- react.js
   |- react-dom.js
```
å…¶ä¸­`qn.js`æ˜¯ç»è¿‡ä¸Šè¿°æ‰€æœ‰`hack`ä¹‹åçš„

[æ–‡ä»¶åœ°å€](https://github.com/7revor/fie-react-update-lib)
