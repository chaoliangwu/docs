<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>升级动机 | 7revor</title>
    <meta name="description" content="可爱又迷人的反派角色">
    <link rel="icon" href="/docs/img/favicon.ico">
    
    <link rel="preload" href="/docs/assets/css/0.styles.8cfe9ac6.css" as="style"><link rel="preload" href="/docs/assets/js/app.bc99d866.js" as="script"><link rel="preload" href="/docs/assets/js/15.6cc44db7.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.ed429399.js"><link rel="prefetch" href="/docs/assets/js/11.f254633c.js"><link rel="prefetch" href="/docs/assets/js/12.b163d66e.js"><link rel="prefetch" href="/docs/assets/js/13.672afa93.js"><link rel="prefetch" href="/docs/assets/js/14.a222c189.js"><link rel="prefetch" href="/docs/assets/js/16.2c5bc323.js"><link rel="prefetch" href="/docs/assets/js/17.97efe9f1.js"><link rel="prefetch" href="/docs/assets/js/18.addf92e5.js"><link rel="prefetch" href="/docs/assets/js/19.671f398e.js"><link rel="prefetch" href="/docs/assets/js/2.a9bc8d68.js"><link rel="prefetch" href="/docs/assets/js/20.835d80cf.js"><link rel="prefetch" href="/docs/assets/js/21.56babc55.js"><link rel="prefetch" href="/docs/assets/js/22.345bd356.js"><link rel="prefetch" href="/docs/assets/js/23.c30ff3df.js"><link rel="prefetch" href="/docs/assets/js/24.3ec9cec4.js"><link rel="prefetch" href="/docs/assets/js/25.89435abb.js"><link rel="prefetch" href="/docs/assets/js/26.81dbd5b9.js"><link rel="prefetch" href="/docs/assets/js/27.9957afa5.js"><link rel="prefetch" href="/docs/assets/js/28.561890b4.js"><link rel="prefetch" href="/docs/assets/js/29.5f11397b.js"><link rel="prefetch" href="/docs/assets/js/3.d4f05896.js"><link rel="prefetch" href="/docs/assets/js/30.3703247d.js"><link rel="prefetch" href="/docs/assets/js/31.bc6a3ce2.js"><link rel="prefetch" href="/docs/assets/js/32.97ae4a2a.js"><link rel="prefetch" href="/docs/assets/js/33.5a0687b4.js"><link rel="prefetch" href="/docs/assets/js/4.8daa3127.js"><link rel="prefetch" href="/docs/assets/js/5.725a8fde.js"><link rel="prefetch" href="/docs/assets/js/6.bd5143d1.js"><link rel="prefetch" href="/docs/assets/js/7.383fdf3a.js"><link rel="prefetch" href="/docs/assets/js/8.0e52f10d.js"><link rel="prefetch" href="/docs/assets/js/9.8117c74d.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.8cfe9ac6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">7revor</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link router-link-active">Documents</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/docs/Notes/" class="nav-link router-link-active">Documents</a></div><div class="nav-item"><a href="/docs/Learning/" class="nav-link">Learning</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/Notes/publish.html" class="sidebar-link">发布宝贝</a></li><li><a href="/docs/Notes/goodsProps.html" class="sidebar-link">宝贝属性详解</a></li><li><a href="/docs/Notes/fieReactUpgrade.html" class="active sidebar-link">fie升级React16实录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#升级动机" class="sidebar-link">升级动机</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#升级过程" class="sidebar-link">升级过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_1-坑" class="sidebar-link">1# 坑</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_1-解决" class="sidebar-link">1# 解决</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_2-坑" class="sidebar-link">2# 坑</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_2-解决" class="sidebar-link">2# 解决</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_3-坑" class="sidebar-link">3# 坑</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_3-解决" class="sidebar-link">3# 解决</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_4-坑" class="sidebar-link">4# 坑</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_4-解决" class="sidebar-link">4# 解决</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_5-坑" class="sidebar-link">5# 坑</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#_5-解决" class="sidebar-link">5# 解决</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#完成" class="sidebar-link">完成</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#附" class="sidebar-link">附</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#root-js" class="sidebar-link">root.js</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#build-js" class="sidebar-link">build.js</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#fie-config-js" class="sidebar-link">fie.config.js</a></li><li class="sidebar-sub-header"><a href="/docs/Notes/fieReactUpgrade.html#lib" class="sidebar-link">lib</a></li></ul></li></ul></li></ul> </div> <div class="page"> <div class="content"><h2 id="升级动机"><a href="#升级动机" class="header-anchor">#</a> 升级动机</h2> <p>工作中两款插件都是使用 <a href="https://github.com/fieteam/fie-toolkit-qnui" target="_blank" rel="noopener noreferrer">fie-toolkit-qnui<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>套件进行开发。使用中发现了它的弊端：</p> <ul><li>内置的 React 版本是 <code>15.6</code>，而现在 React 已经迭代带到 <code>16.9</code>。</li></ul> <blockquote><p>React 16 对核心算法进行了重写，引入了代号为 <strong>Fiber</strong> 的异步渲染架构 ， 它比旧版的更快，更稳定。并且加入了很多优秀的API（比如笔者最喜欢的<a href="https://zh-hans.reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener noreferrer">Hooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p></blockquote> <ul><li>fie 在开发环境下仍然使用 <code>production.min.js</code> 。这将会忽略 <strong>语法检查</strong> 和 <strong>性能提示</strong>，不利于我们构建更好更快的应用。</li> <li>生产模式下的<code>ReactDom</code>渲染异常报错，没有任何的错误以及堆栈信息，有的只是网页链接，打开后才会显示我们的错误信息。但这对debug没有丝毫帮助。代码这么多，完全不知道是哪里的问题。</li></ul> <p>这就让下定了升级React的决心。</p> <p>这么简单的问题肯定不止笔者一个人想到，于是乎兴冲冲的跑去 github 看看有没有人提 issue，
但结果让我很是震惊。</p> <p>fie 的最后更新时间是两年之前，而脚手架配套的<a href="https://github.com/INTL-Alibaba/qnui" target="_blank" rel="noopener noreferrer">QNUI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>组件库,也同样是两年没有更新了。</p> <p>看他们的 github 发现项目组得人都跑去隔壁做 <a href="https://fusion.design" target="_blank" rel="noopener noreferrer">FusionDesign<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>了。。。🤣</p> <p>想要换架构肯定是不可能了，动辄上万行代码，成本实在是难以预估。。</p> <p>只有自己琢磨琢磨升级方法了。</p> <h2 id="升级过程"><a href="#升级过程" class="header-anchor">#</a> 升级过程</h2> <p>脚手架升级表现倒还令人满意，修改<code>package.json</code>，执行 <code>npm install</code>，整个过程一气呵成，也没遇到啥报错。</p> <p>启动服务后打开页面，wait！！！不是升级了吗，怎么还是 15.6 ,也没有任何提示？！！</p> <h3 id="_1-坑"><a href="#_1-坑" class="header-anchor">#</a> 1# 坑</h3> <p>观察<code>webpack.confog.js</code>我们可以发现</p> <div class="language-jsx harmony extra-class"><pre class="language-jsx"><code> externals<span class="token punctuation">:</span> <span class="token punctuation">{</span>
     <span class="token string">'react'</span><span class="token punctuation">:</span> <span class="token string">'React'</span><span class="token punctuation">,</span>
      <span class="token string">'react-dom'</span><span class="token punctuation">:</span> <span class="token string">'ReactDOM'</span><span class="token punctuation">,</span>
      <span class="token string">'react-redux'</span><span class="token punctuation">:</span> <span class="token string">'ReactRedux'</span><span class="token punctuation">,</span>
      <span class="token string">'react-router'</span><span class="token punctuation">:</span> <span class="token string">'ReactRouter'</span><span class="token punctuation">,</span>
      <span class="token string">'react-router-redux'</span><span class="token punctuation">:</span> <span class="token string">'ReactRouterRedux'</span><span class="token punctuation">,</span>
      <span class="token string">'redux-thunk'</span><span class="token punctuation">:</span> <span class="token string">'var window.ReduxThunk.default'</span><span class="token punctuation">,</span>
      <span class="token string">'redux'</span><span class="token punctuation">:</span> <span class="token string">'Redux'</span><span class="token punctuation">,</span>
      <span class="token string">'qnui'</span><span class="token punctuation">:</span> <span class="token string">'qnui'</span> <span class="token punctuation">,</span>
      <span class="token string">'react/lib/ReactTransitionGroup'</span><span class="token punctuation">:</span> <span class="token string">'var window.React.addons.TransitionGroup'</span><span class="token punctuation">,</span>
      <span class="token string">'react/lib/ReactCSSTransitionGroup'</span><span class="token punctuation">:</span> <span class="token string">'var window.React.addons.CSSTransitionGroup'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>fie 打包时直接把 React 排除掉了，采用的是引入 script 的形式。这里我们要把最新的源码拷贝出来，并对 fie 的配置进行修改。</p> <h3 id="_1-解决"><a href="#_1-解决" class="header-anchor">#</a> 1# 解决</h3> <ol><li>在项目中新建目录，<code>/lib/production/</code> 和 <code>/lib/development/</code></li> <li>进入 react 和 react-dom 的 cjs 目录下，分别将 <code>react.production.min.js</code> <code>react-dom.pruduction.min.js</code>，
<code>react.development.js</code> <code>react-dom.development.js</code> 拷贝到刚才创建的目录下。并将他们重命名为<code>react.js</code>和<code>react-dom.js</code></li> <li>修改<code>fie.config.js</code></li></ol> <div class="language-jsx extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  toolkit<span class="token punctuation">:</span> <span class="token string">'fie-toolkit-qnui'</span><span class="token punctuation">,</span>

  toolkitConfig<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> <span class="token number">9001</span><span class="token punctuation">,</span>
    open<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    openTarget<span class="token punctuation">:</span> <span class="token string">'pages/root.html'</span><span class="token punctuation">,</span>
    liveload<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  tasks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    start<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        command<span class="token punctuation">:</span> <span class="token string">'NODE_ENV=development node build.js'</span> 
        <span class="token comment">// 忽略提示信息，可以在此指定 NODE_ENV=production</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    build<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        command<span class="token punctuation">:</span> <span class="token string">'NODE_ENV=production node build.js'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    deploy<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        command<span class="token punctuation">:</span> <span class="token string">'node deploy.js'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    publish<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">提示</p> <p>这里区分 <strong>开发环境</strong> 和 <strong>生产环境</strong>，目的是在开发环境构建中显示完整的 <strong>语法检查</strong> 和 <strong>性能提示</strong>。</p> <p>若不需要，可将 start 和 build 全部指定 NODE_ENV=production</p></div> <ol start="4"><li>修改 <code>build.js</code></li></ol> <div class="language-jsx extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> globby <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'globby'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">globby</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token string">'node_modules/babel-polyfill/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/react-redux/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/react-router/umd/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/react-router-redux/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/redux-thunk/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/redux/dist/*'</span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lib/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> 
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">paths</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdirsSync</span><span class="token punctuation">(</span><span class="token string">'build/lib/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'build/lib/'</span> <span class="token operator">+</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//使用统计</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'copy files to build/lib done ! mode:'</span><span class="token operator">+</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>修改<code>pages/js/root.js</code></li></ol> <p>这个文件是 fie 对各种外置 script 进行加载的过程，上一步我们修改了要引入的 script 文件后，要在这里进行适配。</p> <p>我们可以看到加载顺序为 :</p> <p><code>polyfill</code> =&gt; <code>react-with-addons</code> =&gt; <code>react-dom</code> =&gt; <code>redux</code> =&gt; <code>... ...</code></p> <p>这里的 react-with-addons 就是 React 15.6 和 React-addons 的合体。</p> <p>我们将其路径修改为<code>../build/lib/react.js</code>,将 react-dom 路径修改为<code>../build/lib/react-dom.js</code></p> <p>到这里，第一步脚手架的修改工作就完成了！（但好像事情没有这么简单😂）</p> <p>ok，执行 <code>fie start</code>，打开我们熟悉的界面，发现一片空白。于是乎 F12 打开控制台，果不其然一片报错。
其中最显眼的两个:</p> <ul><li><code>Cannot read property 'string' of undefined</code></li> <li><code>Cannot read property 'createClass' of undefined</code></li> <li><code>Cannot read property 'ReactTransitionGroup' of undefined</code></li></ul> <p>打开堆栈信息一看，全都是年迈的 QNUI 报的错。</p> <h3 id="_2-坑"><a href="#_2-坑" class="header-anchor">#</a> 2# 坑</h3> <p>React16 去除掉了<code>PropTypes</code> <code>createClass</code> 以及 <code>ReactTransitionGroup</code>，取而代之的是<code>prop-types</code> <code>create-react-class</code> 和 <code>react-transition-group</code>第三方库。</p> <p>而年久失修的QNUI，在使用<code>react.PropTypes.string</code>以及<code>react.createClass</code>时，就会出错了。</p> <h3 id="_2-解决"><a href="#_2-解决" class="header-anchor">#</a> 2# 解决</h3> <p>本来笔者的想法是对 React 库进行修改，把删掉的三个API添加进去。想了想实在是太麻烦，对源码动刀可是一不小心就要GG的。</p> <p>最后使用了一个巧妙地方式，之前在修改<code>pages/js/root.js</code>时，引入了 <code>react-with-addons</code>。其中就包含了react 15。而我们需要的三个API，这不是得来全不费功夫嘛。</p> <p>接着修改<code>root.js</code>，分三步走：</p> <ul><li>先引用<code>react-with-addons</code>，将三个API抽出来。</li> <li>然后引用<code>react16</code>，覆盖掉<code>react15</code>。</li> <li>将抽出来的三个API添加到 react16 中。（不知道会引发什么未知的问题，答案是肯定的。这是后话）</li></ul> <div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code>polyfill<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  reactWith<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react-with-addons.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reactWith<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reactWith<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>reactWith<span class="token punctuation">)</span><span class="token punctuation">;</span>
  reactWith<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>PropTypes<span class="token punctuation">,</span> createClass<span class="token punctuation">,</span>addons<span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>React
    window<span class="token punctuation">.</span>React <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
     <span class="token keyword">var</span> react <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>react<span class="token punctuation">)</span><span class="token punctuation">;</span>
     react<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>React<span class="token punctuation">.</span>PropTypes <span class="token operator">=</span> PropTypes<span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>React<span class="token punctuation">.</span>createClass <span class="token operator">=</span> createClass<span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>React<span class="token punctuation">.</span>addons <span class="token operator">=</span> addons<span class="token punctuation">;</span>
        <span class="token comment">// ... ...</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ok，天衣无缝！</p> <p>运行还是白屏。继续观察控制台，发现这么一个错误信息：</p> <p><code>Cannot read property 'addNodeForSafeClick' of null</code></p> <h3 id="_3-坑"><a href="#_3-坑" class="header-anchor">#</a> 3# 坑</h3> <p>还是QNUI报错。查看源码我们发现，错误来自 Overlay 模态框 组件。</p> <div class="language-jsx harmony extra-class"><pre class="language-jsx"><code><span class="token comment">// ... ...</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>overlay <span class="token operator">=</span> e<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unstable_renderSubtreeIntoContainer</span>
      <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> overlay<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wrap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ... ...</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">addNodeForSafeClick</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
<span class="token comment">//... ...</span>
</code></pre></div><p>它使用了这么一个 API <code>ReactDom.unstable_renderSubtreeIntoContainer</code></p> <p>这个 API 的作用是将元素渲染到父组件之外的DOM,用来做弹窗效果再适合不过。但他毕竟是有前缀<code>unstable</code>的，肯定在某些情况下会有问题。</p> <p>在 react15 中，调用这个方法会直接返回被渲染元素的实例，而 react16 则会返回 <code>null</code></p> <p>所以这里会有<code>Cannot read property 'addNodeForSafeClick' of null</code>这个错误出现。</p> <h3 id="_3-解决"><a href="#_3-解决" class="header-anchor">#</a> 3# 解决</h3> <p>React16新增了<a href="https://zh-hans.reactjs.org/docs/portals.html" target="_blank" rel="noopener noreferrer"><code>Portals</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来更好的实现该功能。</p> <p>开始是想直接替换掉API，但后来发现两个API虽然功能相同，但是使用起来却大相径庭。</p> <p>如果用<code>Portals</code>改写整个组件，风险和工作量还是很大。因为整个QNUI关于浮层的组件都是基于这个<code>Overlay</code>。</p> <p>没办法只能继续分析源码，看一下为啥现在返回是 null 。</p> <p>分析源码发现该API允许接收一个回调函数，回调函数绑定的<code>this</code>为被渲染元素实例。而触发回调时使用了一个<code>flushSyncCallbackQueueImpl</code>的内部API，意思也就是将所有回调放在微任务队列里统一执行。</p> <p>大体上理解就是是旧版同步渲染后直接返回实例，而现在的异步渲染架构无法立即获取实例，需要借助回调函数。</p> <p>这样一来思路就清晰了，我们在所有<code>unstable_renderSubtreeIntoContainer</code>的地方加入回调，在回调中处理实例绑定，而在所有使用到该实例的地方将其加入宏任务队列延迟调用，问题迎刃而解。</p> <p>大概像这样：</p> <div class="language-jsx harmony extra-class"><pre class="language-jsx"><code><span class="token comment">// ... ...</span>
<span class="token keyword">var</span> self4 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
 e<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unstable_renderSubtreeIntoContainer</span>
      <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> overlay<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wrap<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        self4<span class="token punctuation">.</span>overlay <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ... ...</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">addNodeForSafeClick</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//... ...</span>
</code></pre></div><p>处理完这一问题后，将我们 hack 后的包放在<code>lib/production/</code>下，用它替换qnui</p> <p><code>qnui.setAttribute('src', '//g.alicdn.com/qn/QNUI-OPEN/0.6.1/qnui.min.js?qntag=1');</code></p> <p>替换为</p> <p><code>qnui.setAttribute('src', '../build/lib/qnui.js?qntag=1');</code></p> <p>再次刷新页面，这次因该不会有啥问题了把。。。</p> <h3 id="_4-坑"><a href="#_4-坑" class="header-anchor">#</a> 4# 坑</h3> <p>我靠，这次出了一个摸不着头脑的问题</p> <div class="language-jsx harmony extra-class"><pre class="language-jsx"><code>Uncaught Error<span class="token punctuation">:</span> Element ref was specified <span class="token keyword">as</span> a <span class="token function">string</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>$<span class="token punctuation">.</span>$onsale<span class="token punctuation">)</span> but no owner was <span class="token keyword">set</span><span class="token punctuation">.</span> This could happen <span class="token keyword">for</span> one <span class="token keyword">of</span> the following reasons<span class="token punctuation">:</span>
<span class="token number">1.</span> You may be adding a ref to a <span class="token keyword">function</span> component
<span class="token number">2.</span> You may be adding a ref to a component that was not created inside a component's render method
<span class="token number">3.</span> You have multiple copies <span class="token keyword">of</span> React loaded
</code></pre></div><h3 id="_4-解决"><a href="#_4-解决" class="header-anchor">#</a> 4# 解决</h3> <p>这个问题看描述大概是使用了不同的react版本导致的。解决方法笔者也是误打误撞，将<code>react.addons.TransitionGroup</code>替换为了第三方库<code>react-transition-group</code>就好了。</p> <p>修改方式：</p> <ol><li>还是<code>root.js</code>
在 script 引用中加入<code>react-transition-group</code>,同时不在将<code>addons</code>添加到react16 上</li></ol> <div class="language-jsx extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code>reactWith<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>PropTypes<span class="token punctuation">,</span> createClass<span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>React
  window<span class="token punctuation">.</span>React <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> react <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>react<span class="token punctuation">)</span><span class="token punctuation">;</span>
  react<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> addons <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addons<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react-transition-group.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addons<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addons<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>addons<span class="token punctuation">)</span><span class="token punctuation">;</span>
    addons<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>React<span class="token punctuation">.</span>PropTypes <span class="token operator">=</span> PropTypes<span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>React<span class="token punctuation">.</span>createClass <span class="token operator">=</span> createClass<span class="token punctuation">;</span>
      <span class="token keyword">var</span> reactDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reactDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react-dom.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reactDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reactDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>reactDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>修改 <code>qn.js</code>
第一行的位置</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>e<span class="token punctuation">.</span>qnui <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>React<span class="token punctuation">,</span> e<span class="token punctuation">.</span>ReactDOM<span class="token punctuation">,</span> e<span class="token punctuation">.</span>React<span class="token punctuation">.</span>addons<span class="token punctuation">.</span>TransitionGroup<span class="token punctuation">)</span>
</code></pre></div><p>修改为</p> <div class="language-js extra-class"><pre class="language-js"><code>e<span class="token punctuation">.</span>qnui <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>React<span class="token punctuation">,</span> e<span class="token punctuation">.</span>ReactDOM<span class="token punctuation">,</span> e<span class="token punctuation">.</span>ReactTransitionGroup<span class="token punctuation">.</span>TransitionGroup<span class="token punctuation">)</span>
</code></pre></div><p>这里的 e 为全局 window 对象，我们引入<code>react-transition-group</code>后，会自动为 window 注入 <code>ReactTransitionGroup</code></p> <h3 id="_5-坑"><a href="#_5-坑" class="header-anchor">#</a> 5# 坑</h3> <p>测试过程中发现这样一个报错</p> <div class="language-js extra-class"><pre class="language-js"><code>Cannot read property <span class="token string">'getContentNode'</span> <span class="token keyword">of</span> <span class="token keyword">null</span>
</code></pre></div><p>还是 <code>Overlay</code> 的问题。这个错误不是必现的。出现这个错误须符合以下条件</p> <ul><li>页面出现浮层也就是Overlay</li> <li>Overlay 的点击事件直接跳转到新页面</li> <li>在新页面上点击就会报错</li></ul> <h3 id="_5-解决"><a href="#_5-解决" class="header-anchor">#</a> 5# 解决</h3> <p>具体的源码就不贴了，这里分析一下大体原因：</p> <p>Overlay的点击事件是通过 <code>document.addEventlistener</code> 绑定的。也就是说：</p> <p>弹层出现后，qnui 为 document 增加 click 监听，当用户点击时，判断目标元素是否为 Overlay。如果是，那么执行点击回调，如果不是，将其隐藏。</p> <p>当我们路由跳转到新页面后，弹层直接被卸载,而监听没有去除。这样在新页面点击时触发监听导致报错。</p> <p>源码在 componentWillUnmount 生命周期中有去除监听的操作，但这个地方直接跳转页面会导致代码执行被打断。</p> <p>一开始想到解决方式是为跳转增加延迟，但考虑到用户体验以及稳定性，决定对组件源码做一下兼容。</p> <ul><li>调用之前判断组件是否已卸载，如果已卸载，停止调用并手动去除监听。</li></ul> <h2 id="完成"><a href="#完成" class="header-anchor">#</a> 完成</h2> <p>打开浏览器刷新页面，看着久违的页面浮现在我们眼前，真的是留下了激动地口水。</p> <p><code>React 16</code>我们可以为所欲为！</p> <h2 id="附"><a href="#附" class="header-anchor">#</a> 附</h2> <h3 id="root-js"><a href="#root-js" class="header-anchor">#</a> <code>root.js</code></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 根据QueryString参数名称获取值</span>
<span class="token keyword">function</span> <span class="token function">getQueryStringByName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[\?\&amp;]</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=([^\&amp;]+)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> result<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> version <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">//var version = &quot;-2019072301&quot;; //打包之后的版本号</span>

  <span class="token keyword">var</span> event <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token function">getQueryStringByName</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> numiid <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token function">getQueryStringByName</span><span class="token punctuation">(</span><span class="token string">'iid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 商品详情</span>
  <span class="token keyword">var</span> itemStatus <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token function">getQueryStringByName</span><span class="token punctuation">(</span><span class="token string">'itemStatus'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 商品列表</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token string">'event_itemList'</span> <span class="token operator">||</span> event <span class="token operator">==</span> <span class="token string">'itemList'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> itemStatus <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'hasshowcase'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 橱窗推荐--九宫格</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/itemManage/itemList/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>itemStatus<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/itemManage/itemList</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token string">'event_itemDetail'</span> <span class="token operator">||</span> event <span class="token operator">==</span> <span class="token string">'itemDetail'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// /商品明细 新加参数itemDetail</span>
      <span class="token comment">// window.location.href = &quot;../pc/web/root.html?event=itemEdit&amp;num_iid=&quot; + numiid;</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/itemManage/itemDetail/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>numiid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token string">'customEvent'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// /进入商品插件    或指定功能</span>
      <span class="token keyword">var</span> itemStatus <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token function">getQueryStringByName</span><span class="token punctuation">(</span><span class="token string">'itemStatus'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 类型</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> itemStatus <span class="token operator">!=</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> itemStatus <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'itemList'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 商品管理</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/itemManage/itemList</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'waterMark'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 主图水印</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/templet/waterMark</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'mobileDetail'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 手机详情</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/mobileDetail</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'smartList'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 智能上下架</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/flowUp/smartList</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'smartWindow'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 智能橱窗</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/flowUp/smartWindow</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'titleOptimize'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 标题优化</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/flowUp/titleOptimize/itemList/aa</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'activeCenter'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 活动中心</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/more/activeCenter</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'itemList'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 优化宝贝</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/itemManage/itemList</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>itemStatus <span class="token operator">==</span> <span class="token string">'editItem'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 编辑宝贝</span>
          <span class="token keyword">var</span> numIid <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token function">getQueryStringByName</span><span class="token punctuation">(</span><span class="token string">'numIid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 商品编号</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/itemManage/itemDetail/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>numIid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> qncss <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qncss<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">,</span> <span class="token string">'//g.alicdn.com/qn/QNUI-OPEN/0.6.1/qnui.min.css?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qncss<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'rel'</span><span class="token punctuation">,</span> <span class="token string">'stylesheet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qncss<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>qncss<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> css <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  css<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../build/pages/root/index</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意版本号</span>
  css<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'rel'</span><span class="token punctuation">,</span> <span class="token string">'stylesheet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  css<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> polyfill <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  polyfill<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/polyfill.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  polyfill<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  polyfill<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>polyfill<span class="token punctuation">)</span><span class="token punctuation">;</span>
  polyfill<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> reactWith <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reactWith<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react-with-addons.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reactWith<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reactWith<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>reactWith<span class="token punctuation">)</span><span class="token punctuation">;</span>
    reactWith<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>PropTypes<span class="token punctuation">,</span> createClass<span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>React
      window<span class="token punctuation">.</span>React <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> react <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      react<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>react<span class="token punctuation">)</span><span class="token punctuation">;</span>
      react<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> addons <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        addons<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react-transition-group.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        addons<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        addons<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>addons<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addons<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">.</span>React<span class="token punctuation">.</span>PropTypes <span class="token operator">=</span> PropTypes<span class="token punctuation">;</span>
          window<span class="token punctuation">.</span>React<span class="token punctuation">.</span>createClass <span class="token operator">=</span> createClass<span class="token punctuation">;</span>
          <span class="token keyword">var</span> reactDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reactDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react-dom.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reactDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reactDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>reactDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
          reactDom<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> redux <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/redux.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>redux<span class="token punctuation">)</span><span class="token punctuation">;</span>
            redux<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> reactRedux <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              reactRedux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/react-redux.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              reactRedux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              reactRedux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>reactRedux<span class="token punctuation">)</span><span class="token punctuation">;</span>
              reactRedux<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> reactRouter <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reactRouter<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/ReactRouter.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reactRouter<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reactRouter<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>reactRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                reactRouter<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">var</span> reactRouterRedux <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  reactRouterRedux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/ReactRouterRedux.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  reactRouterRedux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  reactRouterRedux<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>reactRouterRedux<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  reactRouterRedux<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> thunk <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thunk<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/redux-thunk.min.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thunk<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thunk<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thunk<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">var</span> qnui <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      qnui<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'../build/lib/qnui.js?qntag=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      qnui<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      qnui<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>qnui<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      qnui<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">var</span> vendor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        vendor<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../build/vendor</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意版本号</span>
                        vendor<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        vendor<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>vendor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        vendor<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          <span class="token keyword">var</span> itemManagement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          itemManagement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../build/pages/root/index</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意版本号</span>
                          itemManagement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          itemManagement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'crossorigin'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>itemManagement<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="build-js"><a href="#build-js" class="header-anchor">#</a> build.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> globby <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'globby'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//STEP 3 将lib copy 到 build 目录</span>

<span class="token function">globby</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token string">'node_modules/babel-polyfill/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/react-redux/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/react-router/umd/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/react-router-redux/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/redux-thunk/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'node_modules/redux/dist/*'</span><span class="token punctuation">,</span>
  <span class="token string">'lib/common/*'</span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lib/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">paths</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdirsSync</span><span class="token punctuation">(</span><span class="token string">'build/lib/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'build/lib/'</span> <span class="token operator">+</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//使用统计</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'copy files to build/lib done ! mode:'</span><span class="token operator">+</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="fie-config-js"><a href="#fie-config-js" class="header-anchor">#</a> fie.config.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 套件帮助文档 可查看: http://gitlab.alibaba-inc.com/fie/fie-toolkit-qnui
 */</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前项目使用的fie套件</span>
  toolkit<span class="token punctuation">:</span> <span class="token string">'fie-toolkit-qnui'</span><span class="token punctuation">,</span>

  toolkitConfig<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 本地服务器端口号,为与交易共存，设置9001</span>
    port<span class="token punctuation">:</span> <span class="token number">9001</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否自动打开浏览器</span>
    open<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token comment">// 打开浏览器后 自动打开的 目标页面</span>
    openTarget<span class="token punctuation">:</span> <span class="token string">'pages/root.html'</span><span class="token punctuation">,</span>
    <span class="token comment">// 文件修改后是否自动刷新浏览器</span>
    liveload<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  tasks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    start<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// 执行build目录的copy</span>
        command<span class="token punctuation">:</span> <span class="token string">'NODE_ENV=development node build.js '</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    build<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// 同步类库到build/lib目录</span>
       command<span class="token punctuation">:</span> <span class="token string">'NODE_ENV=production node build.js'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    deploy<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">//同步到tomcat服务器</span>
        command<span class="token punctuation">:</span> <span class="token string">'node deploy.js'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    publish<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="lib"><a href="#lib" class="header-anchor">#</a> lib</h3> <div class="language- extra-class"><pre class="language-text"><code>lib
|- common
   |- react-transition-group.min.js
   |- react-with-addons.min.js
|- development
   |- qnui.js
   |- react.js
   |- react-dom.js
|- production
   |- qnui.js
   |- react.js
   |- react-dom.js
</code></pre></div><p>其中<code>qn.js</code>是经过上述所有<code>hack</code>之后的</p> <p><a href="https://github.com/7revor/fie-react-update-lib" target="_blank" rel="noopener noreferrer">文件地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">8/23/2019, 12:52:28 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/docs/Notes/goodsProps.html" class="prev">
          宝贝属性详解
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/docs/assets/js/app.bc99d866.js" defer></script><script src="/docs/assets/js/15.6cc44db7.js" defer></script>
  </body>
</html>
